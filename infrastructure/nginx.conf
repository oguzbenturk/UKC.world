server {
  listen 8080;
  server_name plannivo.com www.plannivo.com;

  # Keep ACME challenge and health on HTTP
  location ^~ /.well-known/acme-challenge/ {
    alias /var/www/acme/.well-known/acme-challenge/;
    default_type "text/plain";
    try_files $uri =404;
  }
  # ZeroSSL file-based validation support - Proxy to Backend
  location ^~ /.well-known/pki-validation/ {
    proxy_pass http://backend:4000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
  }
  location = /health { return 200 'ok'; add_header Content-Type text/plain; }

  # Redirect everything else to HTTPS
  location / {
    return 301 https://$host$request_uri;
  }
}

server {
  listen 8443 ssl;
  server_name plannivo.com www.plannivo.com;
  http2 on;

  ssl_certificate     /etc/ssl/plannivo/certificate.crt;
  ssl_certificate_key /etc/ssl/plannivo/private.key;
  ssl_session_timeout 1d;
  ssl_session_cache shared:SSL:10m;
  ssl_protocols TLSv1.2 TLSv1.3;
  ssl_prefer_server_ciphers on;

  # Allow larger file uploads (10MB max)
  client_max_body_size 10m;

  root /usr/share/nginx/html;
  index index.html;

  # Gzip compression for better performance
  gzip on;
  gzip_vary on;
  gzip_min_length 10240;
  gzip_proxied expired no-cache no-store private auth;
  gzip_types text/plain text/css text/xml text/javascript application/javascript application/xml+rss application/json;

  # Security headers
  add_header Strict-Transport-Security "max-age=31536000; includeSubDomains; preload" always;
  # SEC-031 FIX: Use DENY for X-Frame-Options (consistent with backend)
  add_header X-Frame-Options "DENY" always;
  add_header X-XSS-Protection "1; mode=block" always;
  add_header X-Content-Type-Options "nosniff" always;
  add_header Referrer-Policy "no-referrer-when-downgrade" always;
  # SEC-030 FIX: Strict CSP - removed 'unsafe-inline' and 'unsafe-eval', restricted sources
  add_header Content-Security-Policy "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' data: https: blob:; connect-src 'self' ws: wss:; frame-src 'none'; object-src 'none'; base-uri 'self'; form-action 'self'" always;

  # Health endpoint
  location = /health { return 200 'ok'; add_header Content-Type text/plain; }

  # ZeroSSL file-based validation support - Proxy to Backend
  location ^~ /.well-known/pki-validation/ {
    proxy_pass http://backend:4000;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;
  }

  # Handle client routing (SPA)
  # IMPORTANT: index.html should NEVER be cached to ensure users get latest version
  location / {
    try_files $uri $uri/ /index.html;
    
    # Prevent caching of index.html
    location = /index.html {
      add_header Cache-Control "no-cache, no-store, must-revalidate";
      add_header Pragma "no-cache";
      add_header Expires "0";
    }
  }

  # Handle assets with proper caching (these have hashed filenames)
  location /assets/ {
    expires 1y;
    add_header Cache-Control "public, immutable";
    try_files $uri =404;
  }

  # API proxy to backend with resolver for dynamic host resolution
  location /api/ {
    resolver 127.0.0.11 valid=30s;
    set $backend "backend:4000";
    proxy_pass http://$backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_cache_bypass $http_upgrade;
    proxy_read_timeout 86400;
    proxy_connect_timeout 5s;
    proxy_send_timeout 5s;
  }

  # Serve uploaded files directly from shared volume with backend fallback
  location /uploads/ {
    root /var/www;
    try_files $uri $uri/ @uploads_backend;
    add_header Cache-Control "public, max-age=86400";
  }

  location @uploads_backend {
    resolver 127.0.0.11 valid=30s;
    set $backend "backend:4000";
    proxy_pass http://$backend$request_uri;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_read_timeout 86400;
  }

  # WebSocket support for real-time features with resolver
  location /socket.io/ {
    resolver 127.0.0.11 valid=30s;
    set $backend "backend:4000";
    proxy_pass http://$backend;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-Host $server_name;
    proxy_read_timeout 86400;
    proxy_send_timeout 86400;
    proxy_buffering off;
  }

  # Static file caching
  location ~* ^/(?!uploads/).*\.(js|css|png|jpg|jpeg|gif|ico|svg)$ {
    expires 1y;
    add_header Cache-Control "public, immutable";
  }
}
